# pukiwiki自作プラグイン ogp.inc.php
はてなブログの「ブログカード」は魅力的でPukiwikiにも導入したいと思い、自分で見よう見まねでプラグインを作成して個人用のPukiwikiで利用していましたが、せっかくですのでこの外部のOGPを取得してブログカードとして表示するPukiwikiプラグインを公開することにしました。

詳しくはこちらのサイトもご覧ください。
https://oncologynote.jp/?12173bf026

- Pukiwiki 1.5.3および1.5.4RC、PHP 7.4およびPHP 8.0で動作確認しています。
- プラグイン本体はGPL v3です。

## 設置方法

1. まず、[opengraph.php](https://github.com/scottmac/opengraph/) を入手してpluginフォルダに設置します。
2. ogp.inc.phpをpluginフォルダに設置します。
3. cacheフォルダにogpのフォルダを作成し、書込み可能なパーミッションを与えます（666など）。
4. スタイルシートは適宜調整して見栄えを良くします。参考までに、スタイルシートの一例も添付しています。

## 使い方

>\#ogp(取得したいURL)

第2引数以降にnoimgを入れることで画像を非表示にできます。（ver1.5以降）

## 変更履歴

### ver1.0（2019.9.10）[ ](https://oncologynote.jp/?12173bf026#j047861e)

ひとまずOGPを取得して表示する機能を実装しました。

~~現状ではPukiwikiにアクセスがあるたびに参照先サイトのOGPを取得しに行っている。アクセス数がそれほど多くない場合は負荷も無視できる程度であるが、もしアクセス数が非常に多いPukiwikiの場合はいちいち参照先にデータを取得しにゆくのは効率が悪い。何らかの方法でOGPデータや画像をキャッシュすることができればと思うが、現状では荷が重い（PHP技術的に）。~~

### ver1.1（2019.9.17）[ ](https://oncologynote.jp/?12173bf026#z7aaf86d)

キャッシュ機能を実装しました。CACHE.DIRのogpというサブフォルダにキャッシュを配置します。またキャッシュ機能を実装したことでHTTPS外へのリンクを張った際に「安全でないサイト」と表示される問題も初回キャッシュ作成時以降は表示されなくなり、（ほぼ）解決しました。

しかし古いキャッシュを破棄する機能はまだ実装していません。また画像の拡張子を判断するステップを省略しているため、jpegもPNGも'.img'としています。主要ブラウザでは問題なく表示されるようですが、いずれ修正しなければならない。

また、URLを省略したOGPを提供するサイト（NCBI Pubmedなど）へのリンクを貼れるようにしました。

### ver1.2（2019.11.10）[ ](https://oncologynote.jp/?12173bf026#w45f8d9b)

第2引数にampを入れることでimgタグをamp-imgに変更できるようにしました（ver1.5から再びAMP非対応になっています）。

AMP対応したサイトの場合はimgタグを使用することができません。そのためOGPプラグインが書き出すタグもimgではなくamp-imgタグを使用するようにしています。これにともなってスタイルシートも若干複雑になります。ver1.2対応のスタイルシートを使用してください。

### ver1.3 (2020.5.2)[ ](https://oncologynote.jp/?12173bf026#sff2b6b0)

ファイル形式（GIF・PNGなど）を反映したキャッシュファイル拡張子になるようにしました。従来のキャッシュも利用できます。なお、ファイル形式を取得するために[getimagesize()](https://www.php.net/manual/ja/book.image.php)を使用しているため、PHPでGDがサポートされている必要があります。お使いのサーバーのPHPの設定をご確認ください。

### ver1.31 (2020.5.5)[ ](https://oncologynote.jp/?12173bf026#td4248ba)

キャッシュ関連のバグを修正。

### ver1.4 (2020.7.16)[ ](https://oncologynote.jp/?12173bf026#aaf5e258)

画像が存在しない場合に画像を非表示（noimg）とするよう対応しました。[こちらのサイト](https://jpngamerswiki.com/?6d9c96fe42)も参考にさせていただきました。ありがとうございました。画像がない場合や画像ファイルのサイズが'0'の場合はnoimgとなります。

### ver1.5 (2020.7.24)[ ](https://oncologynote.jp/?12173bf026#sc41672a)

- WEBP画像があればWEBP画像を表示しなければfallbackするのに対応しました。
- 複数の引数に対応(noimg,prefetch)しました。

### ver1.6 (2021.11.26)[ ](https://oncologynote.jp/?12173bf026#nfff5d5b)

- PHP 8.0でエラーが出ないよう微修正
- このバージョンからGitHubに公開しました。
- getimagesizeではなくexif_imagetypeを利用するようにしました。

### ver1.7 (2023.1.13)

- 自己Pukiwiki内のOGPを取得しようとしたときにOGPプラグインでOGPを取得しようとしたページ同士で無限ループにならないように、User Agentでループ上のOGP取得防止を実装

### ver1.9 (2025.7.19)

1. HTTP クライアントの強化
file_get_contents() の代わりに cURL などを使い、User-Agent をブラウザに近いものへ変更したり、リダイレクト・HTTPS 証明書エラーなどを細かく制御できるようにします。HTTP ヘッダーを付けないと拒否するサイトでも対応しやすくなります。

2. OGP 以外のメタタグの活用
OGP が存在しないページは meta[name="description"] や Twitter Card (twitter:) のタグだけがあるケースもあります。現在のライブラリは description や link[rel=image_src] までは拾っていますが、それ以外のメタタグは考慮していません。必要に応じて解析対象を広げることで表示可能な情報が増える可能性があります。

3. 相対 URL の処理
og:image にページ内の相対パスが書かれている場合、現状のライブラリではそのまま保存してしまうため、画像を正しく取得できません。ページのベース URL を使って絶対 URL に変換する処理を追加すると対応範囲が広がります。

4. サイト側ブロックへの対処
アクセス頻度が高い場合は相手サイトに負荷をかけたり、ボットとしてブロックされることもあります。適切なキャッシュの利用やアクセス間隔の調整を検討し、ブロックされにくい形で情報を取得するようにします。
